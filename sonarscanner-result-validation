#!/bin/bash

source <(otc-task-include lib/vsts.sh)
source <(otc-task-include lib/console.sh)

# Validade result
task_status_url=$(grep 'INFO: More about the report processing at ' sonarscanner-end-output | egrep -o 'https?://.*')
report_url=$(grep 'INFO: ANALYSIS SUCCESSFUL, you can browse ' sonarscanner-end-output | egrep -o 'https?://.*')
sonar_base_url=$(echo $task_status_url | sed -E 's/\/api\/ce\/task\?id=.*//g')
pooling_attemps=0

while :
do
  if [ -f sonar-task-status.json ]
  then 
    rm sonar-task-status.json
  fi

  if ! curl -u $SONARQUBE_USERKEY: --fail -s $task_status_url > sonar-task-status.json
  then 
    red "Falha ao ler o status sobre a analise do SonarQube"
    red "Nao foi possivel acessar a URL $task_status_url"
    exit 95
  fi

  echo "sonar-taks-status ==============================================="
  cat sonar-task-status.json
  echo
  echo "================================================================="

  sonar_status=$(cat sonar-task-status.json | jq -r -M '.task.status')
  analysis_id=$(cat sonar-task-status.json | jq -r -M '.task.analysisId')
  result_url="$sonar_base_url/api/qualitygates/project_status?analysisId=$analysis_id"

  if [ "$sonar_status" != "IN_PROGRESS" ] && [ "$sonar_status" != "PENDING" ]
  then

    echo "Analise concluida!"

    if [ "$sonar_status" = "SUCCESS" ] 
    then          

      if ! curl -u $SONARQUBE_USERKEY: --fail -s $result_url > sonar-result.json
      then
  	    red "Falha ao ler o resulta da analise do SonarQube"
  	    red "Nao foi possivel acessar a URL $result_url"
  	    exit 96
      fi

      #echo "sonar-result ===================================================="
      #cat sonar-result.json
      #echo
      #echo "================================================================="

      sonar_result=$(cat sonar-result.json | jq -r -M '.projectStatus.status')

      if [ "$sonar_result" = "OK" ]
      then
	      green "Parabens, a validacao pelo SonarQube passou!"
	      
	      exit_code=0
	  else
	      red "Lamento, a validacao pelo SonarQube nao passou. Status retornado: $sonar_result"

        pr_comment_text="A an√°lise do Sonarqube falhou (commit [$(echo $SYSTEM_PULLREQUEST_SOURCECOMMITID | egrep -o '^[0-9a-f]{8}')]($SYSTEM_PULLREQUEST_SOURCEREPOSITORYURI/commit/$SYSTEM_PULLREQUEST_SOURCECOMMITID)). \
Verifique o resultado em [$report_url]($report_url)."
        pr_comment_id=$(vsts-comment-pull-request "$SYSTEM_PULLREQUEST_PULLREQUESTID" "$pr_comment_text")

        echo "Sonar result:"
        echo "--------------------------------------"
        cat sonar-result.json
        echo

	      exit_code=87
      fi

    else
      red "A task de validacao apresentou um status inesperado. Status retornado: $sonar_status"

      exit_code=85
    fi

    echo "Verifique o relatorio em: $report_url"

    exit $exit_code

  elif [ "$pooling_attemps" -gt "60" ]
  then
    red "Nao foi possivel obter o resultado da analise do SonarQube (limite de tentativas excedido)"

    exit 77
  fi

  pooling_attemps=$((pooling_attemps+1))
  echo "Status: $sonar_status"
  sleep 1
done